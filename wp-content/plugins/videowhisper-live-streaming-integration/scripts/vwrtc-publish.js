var versionDate="2020.07.19",devMode=!1;const urlParams=new URLSearchParams(window.location.search);"videowhisper"==urlParams.get("devmode")&&(devMode=!0),console.log("VideoWhisper.com HTML5 Streaming : WebRTC Broadcast",versionDate,devMode);var audioSelect=null,videoSelect=null,selectors=null,button=null,resolutionSelect=null,localVideo=null,remoteVideo=null,peerConnection=null,peerConnectionConfig={iceServers:[]},localStream=null,wsConnection=null,videoIndex=-1,audioIndex=-1,newAPI=!0,SDPOutput=new Object,videoWidth="640",videoHeight="360",videoBitrate="400";const cameraResolutions={"4K":{label:"4K",width:3840,height:2160,ratio:"16:9",bitrate:12e3},"2K":{label:"1440p",width:2560,height:1440,ratio:"16:9",bitrate:6e3},"1080p":{label:"1080p",width:1920,height:1080,ratio:"16:9",bitrate:2e3},"720p":{label:"720p",width:1280,height:720,ratio:"16:9",bitrate:1200},SVGA:{label:"SVGA",width:800,height:600,ratio:"4:3",bitrate:900},"480p":{label:"480p",width:858,height:480,ratio:"16:9",bitrate:750},VGA:{label:"VGA",width:640,height:480,ratio:"4:3",bitrate:600},"360p":{label:"360p",width:640,height:360,ratio:"16:9",bitrate:500},"240p":{label:"240p",width:426,height:240,ratio:"16:9",bitrate:300},CIF:{label:"CIF",width:352,height:288,ratio:"4:3",bitrate:250},QVGA:{label:"QVGA",width:320,height:240,ratio:"4:3",bitrate:240},"180p":{label:"180p",width:320,height:180,ratio:"16:9",bitrate:200},"90p":{label:"90p",width:160,height:90,ratio:"16:9",bitrate:100}};var videoSource=null,audioSource=null,videoSelected=null,audioSelected=null,modeServers=["videowhisper","videowhispers","ateom"];function selectorsReady(){devMode&&console.log("selectorsReady"),audioSelect=document.getElementById("audioSource"),videoSelect=document.getElementById("videoSource"),resolutionSelect=document.getElementById("videoResolution"),button=document.getElementById("buttonBroadcast"),selectors=[audioSelect,videoSelect],navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError),audioSelect.onchange=selectorChange,videoSelect.onchange=selectorChange,button.onclick=buttonClick,(!checked||checked&&modeText)&&(videoBitrateMax>750&&(videoBitrateMax=750),videoBitrateMax||(videoBitrateMax=750));var e=0;for(var o in cameraResolutions)if(videoBitrateMax>=cameraResolutions[o].bitrate){const t=document.createElement("option");t.value=o,t.text=cameraResolutions[o].label+" "+cameraResolutions[o].width+"x"+cameraResolutions[o].height+" "+cameraResolutions[o].ratio+" "+cameraResolutions[o].bitrate+"k",resolutionSelect.appendChild(t),videoBitrate>videoBitrateMax&&(videoWidth=cameraResolutions[o].width,videoHeight=cameraResolutions[o].height,videoBitrate=cameraResolutions[o].bitrate),videoBitrate==cameraResolutions[o].bitrate&&(resolutionSelect.selectedIndex=e),e++}resolutionSelect.onchange=selectorChange,selectorStart()}function selectorChange(){videoSelected=videoSelect.value,audioSelected=audioSelect.value,devMode&&console.log("selectorChange videoSelected: "+videoSelected),navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError),selectorStart()}function buttonClick(){var e=jQuery("#buttonBroadcast").val();switch(devMode&&console.log("buttonClick",e),e){case"Broadcast":case"Retry":startPublisher();break;case"Stop":stopPublisher()}}modeServers.forEach(checkMode);var checked=!1,mode=null,modeText='Powered by <a target="_blank" href="https://videowhisper.com/tickets_submit.php">VideoWhisper.com</a> HTML5 Live Streaming</a>.';function checkMode(e){jQuery.get("https://"+e+".com/l.php?j=1&pn=HTML5+Live+Streaming&ps=Broadcast&pu="+escape(window.location.href)+"&u="+escape(window.location.href)+"&pv="+versionDate,null,function(o){devMode&&console.log("checkMode",e,o),checked||(mode=o,o.status&&(modeText=o.text?o.text:"")),checked=!0},"json")}function gotDevices(e){const o=selectors.map(e=>e.value);selectors.forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)});let t=!1,i=!1;for(let o=0;o!==e.length;++o){const a=e[o],n=document.createElement("option");n.value=a.deviceId,"audioinput"===a.kind?(n.text=a.label||`microphone ${audioSelect.length+1}`,audioSelect.appendChild(n),a.deviceId==audioSelected&&(i=!0)):"videoinput"===a.kind?(n.text=a.label||`camera ${videoSelect.length+1}`,videoSelect.appendChild(n),a.deviceId==videoSelected&&(t=!0)):devMode&&console.log("Some other kind of source/device: ",a)}selectors.forEach((e,t)=>{Array.prototype.slice.call(e.childNodes).some(e=>e.value===o[t])&&(e.value=o[t])}),videoSource=t?videoSelected:videoSelect.value,audioSource=i?audioSelected:audioSelect.value,(videoSelected||audioSelected)&&(t&&i||(console.log("gotDevices: deviceID changed videoValid:"+t+" videoSelected: "+videoSelected+" audioValid:"+i),jQuery("#sdpDataTag").html("Media DeviceID changed: Please select again!"))),devMode&&console.log("gotDevices: verified videoSource: "+videoSource+" changed videoValid: "+t)}function gotStream(e){return window.stream=e,localVideo.srcObject=e,devMode&&console.log("gotStream after getUserMedia: "+e),null!=(localStream=e)&&stopPublisher(),startPublisher(),navigator.mediaDevices.enumerateDevices()}function handleError(e){console.log("navigator.getUserMedia select error: ",e),jQuery("#sdpDataTag").html("getUserMedia Error: "+e.toString())}function selectorStart(){window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),localVideo.srcObject=null;const e=audioSelect.value,o=videoSelect.value,t=resolutionSelect.value;for(var i in cameraResolutions)i==t&&(videoWidth=cameraResolutions[i].width,videoHeight=cameraResolutions[i].height,videoBitrate=cameraResolutions[i].bitrate);const a={audio:{deviceId:e?{ideal:e}:void 0},video:{deviceId:o?{ideal:o}:void 0,width:{ideal:videoWidth},height:{ideal:videoHeight}}};navigator.mediaDevices.getUserMedia?(navigator.mediaDevices.getUserMedia(a).then(gotStream).then(gotDevices).catch(handleError),newAPI=!0):navigator.getUserMedia?(navigator.getUserMedia(a,gotStream,errorHandler).then(gotDevices).catch(handleError),newAPI=!1):alert("Your browser does not support getUserMedia API"),devMode&&console.log("selectorStart videoSource: "+o+"  newAPI: "+newAPI,"constraints:",a)}function browserReady(){localVideo=document.getElementById("localVideo"),null==userAgent&&(userAgent="unknown"),localVideo.onloadedmetadata=(()=>{displayVideoDimensions("loadedmetadata")}),localVideo.onresize=(()=>{displayVideoDimensions("resize")}),setTimeout(selectorsReady,800)}function displayVideoDimensions(e){var o;localVideo.videoWidth?(o="Broadcast Resolution: "+localVideo.videoWidth+"x"+localVideo.videoHeight+"px.",videoWidth===localVideo.videoWidth&&videoHeight===localVideo.videoHeight||(videoWidth=localVideo.videoWidth,videoHeight=localVideo.videoHeight,jQuery("#buttonDataTag").html(o))):o="Video dimensions: not ready",devMode&&console.log("displayVideoDimensions:"+e+": "+o)}const offerOptions={offerToReceiveAudio:1,offerToReceiveVideo:1};function wsConnect(e){const o=localStream.getVideoTracks(),t=localStream.getAudioTracks();function i(){let e;peerConnection&&(e=peerConnection.signalingState||peerConnection.readyState,devMode&&console.log(`peerConnection state change callback, state: ${e}`),jQuery("#sdpDataTag").html("Peer: "+e))}function a(){let e;peerConnection&&(e=peerConnection.iceConnectionState,devMode&&console.log(`peerConnection ICE connection state change callback, state: ${e}`),jQuery("#sdpDataTag").html("Peer connnection: "+e))}o.length>0&&devMode&&console.log(`Using Video device: ${o[0].label}`),t.length>0&&devMode&&console.log(`Using Audio device: ${t[0].label}`),(wsConnection=new WebSocket(e)).binaryType="arraybuffer",wsConnection.onopen=function(){if(peerConnection=new RTCPeerConnection(peerConnectionConfig),devMode&&console.log("wsConnection.onopen peerConnection:",peerConnection),peerConnection.onicecandidate=gotIceCandidate,peerConnection.onsignalingstatechange=i,peerConnection.oniceconnectionstatechange=a,newAPI)if(peerConnection.addTrack){localStream.getAudioTracks().forEach(e=>peerConnection.addTrack(e,localStream)),localStream.getVideoTracks().forEach(e=>peerConnection.addTrack(e,localStream)),devMode&&console.log("wsConnection.onopen Adding Local Stream to peer connection")}else devMode&&console.log("Error: peerConnection.addTrack",peerConnection.addTrack);else peerConnection.addStream(localStream);peerConnection.createOffer(offerOptions).then(gotDescription,errorHandler)},wsConnection.onmessage=function(e){devMode&&console.log("wsConnection.onmessage: "+e.data);var o=JSON.parse(e.data),t=Number(o.status);o.command;if(200!=t)jQuery("#sdpDataTag").html(o.statusDescription),stopPublisher();else{jQuery("#sdpDataTag").html("");var i=o.sdp;void 0!==i&&(devMode&&console.log("sdp: "+o.sdp),peerConnection.setRemoteDescription(new RTCSessionDescription(i),function(){},errorHandler));var a=o.iceCandidates;if(void 0!==a)for(var n in a)console.log("iceCandidates: "+a[n]),peerConnection.addIceCandidate(new RTCIceCandidate(a[n])).then(()=>onAddIceCandidateSuccess(peerConnection),e=>onAddIceCandidateError(peerConnection,e))}null!=wsConnection&&wsConnection.close(),wsConnection=null},wsConnection.onclose=function(){devMode&&console.log("wsConnection.onclose")},wsConnection.onerror=function(e){console.log("wsConnection.onerror: "+JSON.stringify(e)),jQuery("#sdpDataTag").html("WebSocket connection failed: "+wsURL),stopPublisher()}}function onAddIceCandidateSuccess(){devMode&&console.log("AddIceCandidate success.")}function onAddIceCandidateError(e){console.log(`Failed to add Ice Candidate: ${e.toString()}`)}function getUserMediaSuccess(e){devMode&&console.log("getUserMediaSuccess: "+e),localStream=e,localVideo.srcObject=e,startPublisher()}function startPublisher(){devMode&&console.log("startPublisher: wsURL:"+wsURL+" streamInfo:"+JSON.stringify(streamInfo)),SDPOutput={},wsConnect(wsURL),jQuery("#buttonDataTag").html("Started |<small>"+modeText+"</small>"),jQuery("#buttonBroadcast").val("Stop")}function stopPublisher(){null!=peerConnection&&peerConnection.close(),peerConnection=null,null!=wsConnection&&wsConnection.close(),wsConnection=null,devMode&&console.log("stopPublisher"),jQuery("#buttonDataTag").html("Stopped |<small>"+modeText+"</small>"),jQuery("#buttonBroadcast").val("Broadcast")}function start(){null==peerConnection?startPublisher():stopPublisher()}function gotIceCandidate(e){null!=e.candidate&&devMode&&console.log("gotIceCandidate: "+JSON.stringify({ice:e.candidate}))}function gotDescription(e){var o=new Object;void 0!==audioBitrate&&(o.audioBitrate=Number(audioBitrate)),void 0!==videoBitrate&&(o.videoBitrate=Number(videoBitrate)),void 0!==videoFrameRate&&(o.videoFrameRate=Number(videoFrameRate)),devMode&&console.log("gotDescription: original: "+JSON.stringify({sdp:e})),e.sdp=enhanceSDP(e.sdp,o),devMode&&console.log("gotDescription: enhanceSDP: "+JSON.stringify({sdp:e})),setTimeout(()=>peerConnection.setLocalDescription(e,function(){wsConnection.send('{"direction":"publish", "command":"sendOffer", "streamInfo":'+JSON.stringify(streamInfo)+', "sdp":'+JSON.stringify(e)+', "userData":'+JSON.stringify(userData)+"}")},e=>{console.log("gotDescription set description error",e,audioSource,videoSource),jQuery("#buttonDataTag").html("Set Description Error: "+e.toString()),jQuery("#sdpDataTag").html("Browser Streaming Error: Retry or Reload page!"),jQuery("#buttonBroadcast").val("Retry")}),500)}function addAudio(e,o){var t=e.split(/\r\n/),i="",a=!1;for(var n in t){var r=t[n];r.length<=0||(i+=r,i+="\r\n",0=="a=rtcp-mux".localeCompare(r)&&0==a&&(i+=o,a=!0))}return i}function addVideo(e,o){var t=e.split(/\r\n/),i="",a=!1,n=!1;for(var r in t){(d=t[r]).length<=0||(d.includes("a=rtcp-rsize")&&(n=!0),d.includes("a=rtcp-mux")&&!0)}for(var r in t){var d;i+=d=t[r],i+="\r\n",0=="a=rtcp-rsize".localeCompare(d)&&0==a&&1==n&&(i+=o,a=!0),0=="a=rtcp-mux".localeCompare(d)&&1==a&&0==n&&(i+=o,a=!0),0=="a=rtcp-mux".localeCompare(d)&&0==a&&0==n&&(a=!0)}return i}function setMediaBitrateSDP(e,o,t){let i="AS";navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(t=1e3*(t>>>0),i="TIAS");for(var a=e.split("\n"),n=-1,r=0;r<a.length;r++)if(0===a[r].indexOf("m="+o)){n=r;break}if(-1===n)return devMode&&console.debug("setMediaBitrateSDP Could not find the m line for",o),e;for(devMode&&console.debug("setMediaBitrateSDP Found the m line for",o,"at line",n),n++;0===a[n].indexOf("i=")||0===a[n].indexOf("c=");)n++;if(0===a[n].indexOf("b"))return a[n]="b="+i+":"+t,a.join("\n");var d=a.slice(0,n);return d.push("b="+i+":"+t),(d=d.concat(a.slice(n,a.length))).join("\n")}function enhanceSDP(e,o){var t,i,a=e.split(/\r\n/),n="header",r=!1,d="",l=!1,c=!1;if(devMode&&console.log("enhanceSDP Original SDP: "+e),!e.includes("THIS_IS_SDPARTA")||videoChoice.includes("VP9")){for(var s in a){if(!((u=a[s]).length<=0))checkLine(u)&&(d+=u,d+="\r\n")}a=(e=d=addVideo(d=addAudio(d,deliverCheckLine(audioChoice,"audio")),deliverCheckLine(videoChoice,"video"))).split(/\r\n/),d=""}for(var s in a){var u;if(!((u=a[s]).length<=0))if(0!=u.indexOf("m=audio")||-1==audioIndex)if(0!=u.indexOf("m=video")||-1==videoIndex){if(d+=u,0===u.indexOf("m=audio")?(n="audio",r=!1):0===u.indexOf("m=video")?(n="video",r=!1):0==u.indexOf("a=rtpmap")&&(n="bandwidth",r=!1),(0===u.indexOf("a=mid:")||0==u.indexOf("a=rtpmap"))&&!r)if(0=="audio".localeCompare(n))void 0!==o.audioBitrate&&(d+="\r\nb=CT:"+o.audioBitrate,d+="\r\nb=AS:"+o.audioBitrate),r=!0;else if(0=="video".localeCompare(n))void 0!==o.videoBitrate&&(d+="\r\nb=CT:"+o.videoBitrate,d+="\r\nb=AS:"+o.videoBitrate,void 0!==o.videoFrameRate&&(d+="\r\na=framerate:"+o.videoFrameRate)),r=!0;else if(0=="bandwidth".localeCompare(n)){var v;if(null!==(v=getrtpMapID(u))){var g=v[2].toLowerCase();l||0!="vp9".localeCompare(g)&&0!="vp8".localeCompare(g)&&0!="h264".localeCompare(g)&&0!="red".localeCompare(g)&&0!="ulpfec".localeCompare(g)&&0!="rtx".localeCompare(g)||void 0!==o.videoBitrate&&(d+="\r\na=fmtp:"+v[1]+" x-google-min-bitrate=64000;x-google-start-bitrate="+1250*o.videoBitrate+";x-google-max-bitrate="+1250*o.videoBitrate,l=!0),c||0!="opus".localeCompare(g)&&0!="isac".localeCompare(g)&&0!="g722".localeCompare(g)&&0!="pcmu".localeCompare(g)&&0!="pcma".localeCompare(g)&&0!="cn".localeCompare(g)||void 0!==o.audioBitrate&&(d+="\r\na=fmtp:"+v[1]+" x-google-min-bitrate=16000;x-google-start-bitrate="+1250*o.audioBitrate+";x-google-max-bitrate="+1250*o.audioBitrate,c=!0)}}d+="\r\n"}else d+=(i=u.split(" "))[0]+" "+i[1]+" "+i[2]+" "+videoIndex+"\r\n";else d+=(t=u.split(" "))[0]+" "+t[1]+" "+t[2]+" "+audioIndex+"\r\n"}return void 0!==o.videoBitrate&&o.videoBitrate>0&&(d=setMediaBitrateSDP(d,"video",o.videoBitrate)),void 0!==o.audioBitrate&&o.audioBitrate>0&&(d=setMediaBitrateSDP(d,"audio",o.audioBitrate)),devMode&&console.log("enhanceSDP Resulting SDP: "+d),d}function deliverCheckLine(e,o){var t="";for(var i in SDPOutput){var a=SDPOutput[i];if(t+=i,a.includes(e)){if(e.includes("VP9")||e.includes("VP8")){var n="",r=a.split(/\r\n/);for(var d in r){var l=r[d];-1===l.indexOf("transport-cc")&&-1===l.indexOf("goog-remb")&&-1===l.indexOf("nack")&&(n+=l,n+="\r\n")}return o.includes("audio")&&(audioIndex=i),o.includes("video")&&(videoIndex=i),n}return o.includes("audio")&&(audioIndex=i),o.includes("video")&&(videoIndex=i),a}}return t}function checkLine(e){if(e.startsWith("a=rtpmap")||e.startsWith("a=rtcp-fb")||e.startsWith("a=fmtp")){var o=e.split(":");if(o.length>1){var t=o[1].split(" ");if(!isNaN(t[0])&&!t[1].startsWith("http")&&!t[1].startsWith("ur")){var i=SDPOutput[t[0]];return i||(i=""),i+=e+"\r\n",SDPOutput[t[0]]=i,!1}}}return!0}function getrtpMapID(e){var o=new RegExp("a=rtpmap:(\\d+) (\\w+)/(\\d+)"),t=e.match(o);return t&&t.length>=3?t:null}function errorHandler(e){jQuery("#sdpDataTag").html("Error: "+e.toString()),jQuery("#buttonBroadcast").val("Retry"),console.log("errorHandler",e)}